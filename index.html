<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gerador Autom√°tico de Hor√°rios - Multi-Professor</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap');

    :root {
      --primary-color: #4a00e0;
      --secondary-color: #8e2de2;
      --background-color: #f4f7f6;
      --card-background: #ffffff;
      --text-color: #333;
      --shadow-color: rgba(0, 0, 0, 0.1);
    }

    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      color: var(--text-color);
      padding: 20px;
      min-height: 100vh;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    h1 {
      color: var(--card-background);
      text-align: center;
      margin-bottom: 30px;
      font-weight: 700;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
    }

    .card {
      background-color: var(--card-background);
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 10px 30px var(--shadow-color);
      margin-bottom: 30px;
    }

    h2 {
      color: var(--primary-color);
      border-bottom: 2px solid var(--secondary-color);
      padding-bottom: 10px;
      margin-bottom: 20px;
      font-weight: 600;
    }

    .input-group {
      display: flex;
      gap: 20px;
      margin-bottom: 20px;
      align-items: flex-end;
      flex-wrap: wrap;
    }

    .input-group>div {
      flex-grow: 1;
      min-width: 220px;
    }

    label {
      display: block;
      margin-bottom: 5px;
      font-weight: 600;
      color: #555;
    }

    input[type="text"],
    input[type="number"],
    select {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 8px;
      box-sizing: border-box;
      transition: border-color 0.3s;
    }

    select[multiple] {
      height: 120px;
    }

    input[type="text"]:focus,
    input[type="number"]:focus,
    select:focus {
      border-color: var(--primary-color);
      outline: none;
    }

    .button-group {
      display: flex;
      gap: 15px;
      margin-top: 20px;
      flex-wrap: wrap;
    }

    button {
      padding: 12px 25px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: background-color 0.3s, transform 0.1s;
      color: white;
    }

    button:hover {
      transform: translateY(-2px);
    }

    #addTeacherButton {
      background-color: #28a745;
    }

    #addTeacherButton:hover {
      background-color: #218838;
    }

    #distributeButton {
      background: linear-gradient(45deg, #ff416c, #ff4b2b);
      flex-grow: 1;
    }

    #distributeButton:hover {
      background: linear-gradient(45deg, #e6395e, #e64226);
    }

    #clearButton {
      background-color: #dc3545;
    }

    #clearButton:hover {
      background-color: #c82333;
    }

    #exportPDF,
    #exportXLS {
      background-color: #007bff;
    }

    #exportPDF:hover,
    #exportXLS:hover {
      background-color: #0056b3;
    }

    #teacherList {
      margin-top: 20px;
      border-top: 1px solid #eee;
      padding-top: 15px;
    }

    .teacher-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 15px;
      margin-bottom: 8px;
      background-color: #f8f9fa;
      border-radius: 8px;
      border-left: 5px solid var(--primary-color);
      gap: 10px;
      flex-wrap: wrap;
    }

    .teacher-info {
      font-weight: 500;
    }

    .remove-btn {
      background-color: #dc3545;
      padding: 5px 10px;
      font-size: 0.8em;
    }

    .remove-btn:hover {
      background-color: #c82333;
    }

    /* Tabela de Hor√°rios */
    .timetable-container {
      overflow-x: auto;
    }

    .timetable {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
      min-width: 1000px;
    }

    .timetable th,
    .timetable td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: center;
      font-size: 0.9em;
      height: 50px;
    }

    .timetable th {
      background-color: var(--primary-color);
      color: white;
      font-weight: 600;
      position: sticky;
      top: 0;
    }

    .timetable .time-slot {
      background-color: #f8f9fa;
      font-weight: 600;
      color: var(--primary-color);
      width: 80px;
    }

    .day-header {
      background-color: var(--secondary-color);
      color: white;
      font-weight: 700;
      padding: 10px;
      margin-top: 20px;
      border-radius: 8px 8px 0 0;
    }

    .lesson {
      border-radius: 5px;
      padding: 5px;
      font-size: 0.8em;
      font-weight: 600;
      color: white;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      height: 100%;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      cursor: move;
    }

    .lesson span {
      pointer-events: none;
    }

    .copied-lesson {
      outline: 3px dashed #ffffff;
      outline-offset: 2px;
    }

    /* Cores para os professores (10 cores) */
    .color-0 {
      background-color: #ff6347;
    }

    .color-1 {
      background-color: #4682b4;
    }

    .color-2 {
      background-color: #3cb371;
    }

    .color-3 {
      background-color: #ffa500;
    }

    .color-4 {
      background-color: #9370db;
    }

    .color-5 {
      background-color: #ff69b4;
    }

    .color-6 {
      background-color: #00ced1;
    }

    .color-7 {
      background-color: #f08080;
    }

    .color-8 {
      background-color: #6a5acd;
    }

    .color-9 {
      background-color: #20b2aa;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 15px;
    }

    .stat-item {
      background-color: var(--card-background);
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 5px var(--shadow-color);
      border-left: 5px solid var(--primary-color);
    }

    .stat-item strong {
      display: block;
      font-size: 1.1em;
      color: var(--primary-color);
    }

    .stat-item span {
      font-size: 0.9em;
      color: #666;
    }

    .note {
      background-color: #fff3cd;
      border: 1px solid #ffeeba;
      color: #856404;
      padding: 10px;
      border-radius: 5px;
      margin-bottom: 15px;
      font-size: 0.9em;
    }

    .error-message {
      color: #dc3545;
      font-weight: 600;
      margin-top: 10px;
    }

    .small-hint {
      font-size: 0.75em;
      color: #777;
      margin-top: 4px;
      display: block;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>üìö Gerador Autom√°tico de Hor√°rios - Multi-Professor</h1>

    <div class="card">
      <h2>‚öôÔ∏è Configura√ß√£o de Professores e Disciplinas</h2>
      <p class="note">
        <strong>Cargas Hor√°rias Fixas:</strong>
        Portugu√™s, Matem√°tica: 4 aulas/semana | Ci√™ncias, Hist√≥ria, Ed.F√≠sica, Geografia: 3 aulas/semana | Arte, Ingl√™s:
        2 aulas/semana | Ens. Religioso: 1 aula/semana.
      </p>

      <div class="input-group">
        <div>
          <label for="teacherNameInput">Nome do Professor</label>
          <input type="text" id="teacherNameInput" placeholder="Ex: Maria Silva">
        </div>
        <div>
          <label for="subjectSelect">Disciplina</label>
          <select id="subjectSelect">
            <option value="">Selecione a Disciplina</option>
            <option value="Portugu√™s">Portugu√™s (4 aulas)</option>
            <option value="Matem√°tica">Matem√°tica (4 aulas)</option>
            <option value="Ci√™ncias">Ci√™ncias (3 aulas)</option>
            <option value="Hist√≥ria">Hist√≥ria (3 aulas)</option>
            <option value="Ed.F√≠sica">Ed.F√≠sica (3 aulas)</option>
            <option value="Geografia">Geografia (3 aulas)</option>
            <option value="Arte">Arte (2 aulas)</option>
            <option value="Ingl√™s">Ingl√™s (2 aulas)</option>
            <option value="Ens. Religioso">Ens. Religioso (1 aula)</option>
          </select>
        </div>
        <div>
          <label for="restDaySelect">Dia de Hora-Atividade</label>
          <select id="restDaySelect">
            <option value="Nenhum">Nenhum (trabalha todos os dias)</option>
            <option value="Segunda-feira">Segunda-feira</option>
            <option value="Ter√ßa-feira">Ter√ßa-feira</option>
            <option value="Quarta-feira">Quarta-feira</option>
            <option value="Quinta-feira">Quinta-feira</option>
            <option value="Sexta-feira">Sexta-feira</option>
          </select>
        </div>
        <div>
          <label for="classSelect">Turmas que o professor leciona</label>
          <select id="classSelect" multiple>
            <option value="6¬∫ ano 01">6¬∫ ano 01</option>
            <option value="6¬∫ ano 02">6¬∫ ano 02</option>
            <option value="6¬∫ ano 03">6¬∫ ano 03</option>
            <option value="7¬∫ ano 01">7¬∫ ano 01</option>
            <option value="7¬∫ ano 02">7¬∫ ano 02</option>
            <option value="8¬∫ ano 01">8¬∫ ano 01</option>
            <option value="8¬∫ ano 02">8¬∫ ano 02</option>
            <option value="9¬∫ ano 01">9¬∫ ano 01</option>
            <option value="9¬∫ ano 02">9¬∫ ano 02</option>
          </select>
          <span class="small-hint">Use Ctrl+Clique (ou ‚åò+Clique) para selecionar v√°rias turmas.</span>

        </div>
        <button id="addTeacherButton">‚ûï Adicionar Professor</button>
      </div>

      <div id="teacherList">
        <!-- Professores adicionados ser√£o listados aqui -->
      </div>

      <div class="button-group">
        <button id="distributeButton">üöÄ Distribuir Hor√°rios</button>
        <button id="clearButton">üóëÔ∏è Limpar Quadro</button>
        <button id="exportPDF">üìÑ Exportar PDF</button>
        <button id="exportXLS">üìä Exportar XLS</button>
      </div>
    </div>

    <div class="card">
      <h2>üìä Estat√≠sticas da Distribui√ß√£o</h2>
      <div id="statsContainer" class="stats-grid">
        <!-- Estat√≠sticas ser√£o exibidas aqui -->
      </div>
    </div>

    <div class="card">
      <h2>üìÖ Quadro de Hor√°rios</h2>
      <p class="note">
        Dica: arraste e solte as aulas para ajustar o quadro.
        Clique em uma aula para copi√°-la e depois clique em um espa√ßo vazio para colar (respeitando conflitos de hor√°rio
        do professor).
        Clique em uma aula e aperte a tecla <strong>Delete</strong> para apag√°-la.
      </p>
      <div class="timetable-container">
        <div id="timetableContainer">
          <!-- O quadro de hor√°rios ser√° gerado aqui -->
        </div>
      </div>
    </div>
  </div>

  
    <script>
    // Vari√°veis globais
    const days = ["Segunda-feira", "Ter√ßa-feira", "Quarta-feira", "Quinta-feira", "Sexta-feira"];
    const timeSlots = ["07:45 - 08:30", "08:30 - 09:15", "09:15 - 10:00", "10:15 - 11:00", "11:00 - 11:45"];
    const classes = ["6¬∫ ano 01", "6¬∫ ano 02", "6¬∫ ano 03", "7¬∫ ano 01", "7¬∫ ano 02", "8¬∫ ano 01", "8¬∫ ano 02", "9¬∫ ano 01", "9¬∫ ano 02"]; // Turmas fixas

    // Cargas hor√°rias fixas por disciplina
    const fixedLoads = {
      "Portugu√™s": 4,
      "Matem√°tica": 4,
      "Ci√™ncias": 3,
      "Hist√≥ria": 3,
      "Ed.F√≠sica": 3,
      "Geografia": 3,
      "Arte": 2,
      "Ingl√™s": 2,
      "Ens. Religioso": 1
    };

    let teachers = []; // Lista de objetos { name, subject, restDay, load, classes[] }
    let timetable = {}; // Estrutura de dados do hor√°rio
    let teacherColorMap = {};
    let teacherColorCounter = 0;

    // Estados para drag & drop / copiar & colar
    let draggedLessonOrigin = null; // { day, time, className }
    let copiedLesson = null;        // { teacherName, teacherUpper, subjectName, subjectUpper }
    let copiedFrom = null;          // { day, time, className }

    // Inicializa√ß√£o do Quadro de Hor√°rios
    function initializeTimetable() {
      timetable = {};
      days.forEach(day => {
        timetable[day] = {};
        timeSlots.forEach(time => {
          timetable[day][time] = {};
          classes.forEach(className => {
            timetable[day][time][className] = null; // null = slot vazio
          });
        });
      });
    }

    // --- Fun√ß√µes de Utilit√°rio ---

    function getColorIndex(teacherUpper) {
      if (!teacherColorMap[teacherUpper]) {
        teacherColorMap[teacherUpper] = teacherColorCounter % 10;
        teacherColorCounter++;
      }
      return teacherColorMap[teacherUpper];
    }

    function getColorClass(teacherUpper) {
      return "color-" + getColorIndex(teacherUpper);
    }

    function teacherBusy(teacherUpper, day, time) {
      for (const className of classes) {
        const lesson = timetable[day][time][className];
        if (lesson && lesson.teacherUpper === teacherUpper) {
          return true;
        }
      }
      return false;
    }

    // Verifica conflito de professor naquele hor√°rio, permitindo ignorar uma origem (para movimenta√ß√£o)
    function hasTeacherConflict(teacherUpper, day, time, origin) {
      for (const className of classes) {
        const lesson = timetable[day][time][className];
        if (!lesson) continue;
        if (
          origin &&
          origin.day === day &&
          origin.time === time &&
          origin.className === className
        ) {
          continue; // ignora a pr√≥pria aula que est√° sendo movida
        }
        if (lesson.teacherUpper === teacherUpper) {
          return true;
        }
      }
      return false;
    }

    function countSubjectInDay(subjectUpper, className, day) {
      let count = 0;
      for (const time of timeSlots) {
        const lesson = timetable[day][time][className];
        if (lesson && lesson.subjectUpper === subjectUpper) {
          count++;
        }
      }
      return count;
    }

    function shuffleArray(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
    }

    // --- Renderiza√ß√£o da lista de professores ---

    function renderTeacherList() {
      const list = document.getElementById('teacherList');
      list.innerHTML = '';
      teachers.forEach((t, index) => {
        const totalRequired = t.load * (t.classes ? t.classes.length : 0);
        const turmasTexto = t.classes && t.classes.length
          ? ` | Turmas: ${t.classes.join(', ')}`
          : '';
        const item = document.createElement('div');
        item.className = 'teacher-item';
        item.innerHTML = `
          <div class="teacher-info">
            <strong>${t.name}</strong> - ${t.subject} (${totalRequired} aulas totais)
            ${t.restDay !== 'Nenhum' ? `(Hora-Atividade: ${t.restDay})` : ''}${turmasTexto}
          </div>
          <button class="remove-btn" onclick="removeTeacher(${index})">Remover</button>
        `;
        list.appendChild(item);
      });
    }

    // --- Renderiza√ß√£o do quadro de hor√°rios ---

    function renderTimetable() {
      const container = document.getElementById('timetableContainer');
      container.innerHTML = '';

      days.forEach(day => {
        const dayHeader = document.createElement('h3');
        dayHeader.className = 'day-header';
        dayHeader.textContent = day;
        container.appendChild(dayHeader);

        const table = document.createElement('table');
        table.className = 'timetable';

        // Cabe√ßalho da tabela
        let headerHtml = '<thead><tr><th>Hor√°rio</th>';
        classes.forEach(c => {
          headerHtml += `<th>${c}</th>`;
        });
        headerHtml += '</tr></thead>';
        table.innerHTML = headerHtml;

        // Corpo da tabela
        let bodyHtml = '<tbody>';
        timeSlots.forEach(time => {
          bodyHtml += `<tr><td class="time-slot">${time}</td>`;
          classes.forEach(className => {
            const lesson = timetable[day][time][className];
            if (lesson) {
              const colorClass = getColorClass(lesson.teacherUpper);
              const isCopied =
                copiedFrom &&
                copiedFrom.day === day &&
                copiedFrom.time === time &&
                copiedFrom.className === className;
              const copiedClass = isCopied ? 'copied-lesson' : '';
              bodyHtml += `
                <td data-day="${day}" data-time="${time}" data-class="${className}"
                    ondragover="onDragOver(event)" ondrop="onDrop(event)">
                  <div class="lesson ${colorClass} ${copiedClass}"
                       draggable="true"
                       data-day="${day}" data-time="${time}" data-class="${className}"
                       ondragstart="onDragStart(event)"
                       onclick="onLessonClick(event)">
                    <span>${lesson.subjectName}</span>
                    <span>${lesson.teacherName}</span>
                  </div>
                </td>`;
            } else {
              bodyHtml += `
                <td data-day="${day}" data-time="${time}" data-class="${className}"
                    ondragover="onDragOver(event)" ondrop="onDrop(event)"
                    onclick="onCellClick(event)">
                </td>`;
            }
          });
          bodyHtml += '</tr>';
        });
        bodyHtml += '</tbody>';
        table.innerHTML += bodyHtml;
        container.appendChild(table);
      });
    }

    // --- Estat√≠sticas ---

    function renderStats(stats) {
      const container = document.getElementById('statsContainer');
      container.innerHTML = '';

      // Estat√≠sticas por Turma
      classes.forEach(className => {
        let totalAssigned = 0;
        let totalRequired = 0;

        stats.teachers.forEach(t => {
          const required = fixedLoads[t.subject];
          if (t.classes && t.classes.includes(className)) {
            totalRequired += required;
          }

          let assignedForClass = 0;
          days.forEach(day => {
            timeSlots.forEach(time => {
              const lesson = timetable[day][time][className];
              if (lesson && lesson.subjectName === t.subject) {
                assignedForClass++;
              }
            });
          });
          totalAssigned += assignedForClass;
        });

        const item = document.createElement('div');
        item.className = 'stat-item';
        item.innerHTML = `
          <strong>${className}</strong>
          <span>${totalAssigned} / ${totalRequired} aulas totais</span>
        `;
        container.appendChild(item);
      });

      // Estat√≠sticas por Professor
      stats.teachers.forEach(t => {
        const item = document.createElement('div');
        item.className = 'stat-item';
        const totalRequired = t.load * (t.classes ? t.classes.length : 0);
        let statusText = `${t.assigned} / ${totalRequired} aulas alocadas`;
        let extra = '';

        if (t.assigned < totalRequired) {
          extra = `<span class="error-message"> (Faltam ${totalRequired - t.assigned} aulas)</span>`;
        } else if (t.assigned > totalRequired) {
          extra = `<span class="error-message"> (Excedeu ${t.assigned - totalRequired} aulas)</span>`;
        }

        item.innerHTML = `
          <strong>${t.name} (${t.subject})</strong>
          <span>${statusText} ${extra}</span>
        `;
        container.appendChild(item);
      });
    }

    // Recalcula as estat√≠sticas a partir do timetable atual
    function recalcStats() {
      const stats = {
        classes: {},
        teachers: []
      };

      teachers.forEach(t => t.assigned = 0);

      classes.forEach(className => {
        let classAssigned = 0;
        days.forEach(day => {
          timeSlots.forEach(time => {
            const lesson = timetable[day][time][className];
            if (lesson) {
              classAssigned++;
              const teacherObj = teachers.find(
                t => t.name === lesson.teacherName && t.subject === lesson.subjectName
              );
              if (teacherObj) {
                teacherObj.assigned++;
              }
            }
          });
        });
        stats.classes[className] = { assigned: classAssigned };
      });

      stats.teachers = teachers.map(t => ({ ...t }));
      renderStats(stats);
    }

    // --- EXPORTA√á√ÉO ---

    function getTimetableExportHTML() {
  const container = document.getElementById('timetableContainer');

  const html = `
    <html>
      <head>
        <meta charset="UTF-8">
        <title>Quadro de Hor√°rios</title>
        <style>
          @page { margin: 10mm; }

          body {
            font-family: Arial, sans-serif;
          }

          h2 {
            text-align: center;
            margin: 0 0 16px 0;
          }

          h3.day-header {
            background: #8e2de2;
            color: #ffffff;
            padding: 6px 8px;
            margin: 12px 0 0 0;
            font-size: 13px;
          }

          table {
            border-collapse: collapse;
            width: 100%;
            margin-bottom: 12px;
          }

          th, td {
            border: 1px solid #444;
            padding: 4px;
            text-align: center;
            font-size: 11px;
          }

          th {
            background: #4a00e0;
            color: #ffffff;
            font-weight: bold;
          }

          .time-slot {
            background-color: #f8f9fa;
            font-weight: bold;
            color: #4a00e0;
          }

          /* BLOCO DA AULA COM COR POR PROFESSOR */
          .lesson {
            border-radius: 4px;
            padding: 2px 4px;
            font-size: 10px;
            font-weight: bold;
            color: #ffffff;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 26px;
            box-sizing: border-box;
          }

          /* Mesmas cores da tela principal */
          .color-0 { background-color: #ff6347; }  /* Tomato */
          .color-1 { background-color: #4682b4; }  /* SteelBlue */
          .color-2 { background-color: #3cb371; }  /* MediumSeaGreen */
          .color-3 { background-color: #ffa500; }  /* Orange */
          .color-4 { background-color: #9370db; }  /* MediumPurple */
          .color-5 { background-color: #ff69b4; }  /* HotPink */
          .color-6 { background-color: #00ced1; }  /* DarkTurquoise */
          .color-7 { background-color: #f08080; }  /* LightCoral */
          .color-8 { background-color: #6a5acd; }  /* SlateBlue */
          .color-9 { background-color: #20b2aa; }  /* LightSeaGreen */

          @media print {
            body {
              -webkit-print-color-adjust: exact;
              print-color-adjust: exact;
            }
            .lesson {
              -webkit-print-color-adjust: exact;
              print-color-adjust: exact;
            }
          }
        </style>
      </head>
      <body>
        <h2>Quadro de Hor√°rios</h2>
        ${container.innerHTML}
      </body>
    </html>
  `;
  return html;
}

    function exportPDF() {
      const exportHTML = getTimetableExportHTML();
      const printWindow = window.open('', '', 'width=1200,height=800');

      printWindow.document.open();
      printWindow.document.write(exportHTML);
      printWindow.document.close();

      printWindow.focus();
      printWindow.print();
    }

    function exportXLS() {
      const exportHTML = getTimetableExportHTML();

      const blob = new Blob([exportHTML], {
        type: 'application/vnd.ms-excel;charset=utf-8;'
      });

      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'horario_escolar.xls';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    // --- Drag & Drop + Copiar/Colar ---

    function onDragStart(e) {
      const lessonDiv = e.target.closest('.lesson');
      if (!lessonDiv) return;
      const day = lessonDiv.dataset.day;
      const time = lessonDiv.dataset.time;
      const className = lessonDiv.dataset.class;
      draggedLessonOrigin = { day, time, className };
      e.dataTransfer.effectAllowed = 'move';
    }

    function onDragOver(e) {
      e.preventDefault();
    }

    function onDrop(e) {
      e.preventDefault();
      const cell = e.currentTarget.closest('td');
      if (!cell || !draggedLessonOrigin) return;

      const day = cell.dataset.day;
      const time = cell.dataset.time;
      const className = cell.dataset.class;

      if (
        draggedLessonOrigin.day === day &&
        draggedLessonOrigin.time === time &&
        draggedLessonOrigin.className === className
      ) {
        draggedLessonOrigin = null;
        return;
      }

      if (timetable[day][time][className]) {
        alert('Este hor√°rio j√° est√° ocupado. Libere o campo antes de mover outra aula.');
        draggedLessonOrigin = null;
        return;
      }

      const moving = timetable[draggedLessonOrigin.day][draggedLessonOrigin.time][draggedLessonOrigin.className];
      if (!moving) {
        draggedLessonOrigin = null;
        return;
      }

      if (hasTeacherConflict(moving.teacherUpper, day, time, draggedLessonOrigin)) {
        alert('Conflito de hor√°rio: este professor j√° possui aula neste hor√°rio em outra turma.');
        draggedLessonOrigin = null;
        return;
      }

      timetable[draggedLessonOrigin.day][draggedLessonOrigin.time][draggedLessonOrigin.className] = null;
      timetable[day][time][className] = moving;

      draggedLessonOrigin = null;

      renderTimetable();
      recalcStats();
    }

    // Clique em uma aula: copiar
    function onLessonClick(e) {
      const lessonDiv = e.currentTarget;
      const day = lessonDiv.dataset.day;
      const time = lessonDiv.dataset.time;
      const className = lessonDiv.dataset.class;
      const lesson = timetable[day][time][className];
      if (!lesson) return;

      copiedLesson = { ...lesson };
      copiedFrom = { day, time, className };
      renderTimetable();
    }

    // Clique em um campo vazio: colar aula copiada
    function onCellClick(e) {
      const cell = e.currentTarget.closest('td');
      if (!cell || !copiedLesson) return;

      const day = cell.dataset.day;
      const time = cell.dataset.time;
      const className = cell.dataset.class;

      if (timetable[day][time][className]) {
        alert('Este campo j√° possui uma aula. Apague ou mova a aula antes de colar outra.');
        return;
      }

      if (hasTeacherConflict(copiedLesson.teacherUpper, day, time, null)) {
        alert('Conflito de hor√°rio: este professor j√° possui aula neste hor√°rio em outra turma.');
        return;
      }

      timetable[day][time][className] = { ...copiedLesson };
      recalcStats();
      renderTimetable();
    }

    // --- Delete com tecla Delete (apaga a aula selecionada) ---
    function handleKeyDown(e) {
      if (e.key === 'Delete' || e.key === 'Del' || e.keyCode === 46) {
        if (!copiedFrom) return;

        const { day, time, className } = copiedFrom;

        if (
          timetable[day] &&
          timetable[day][time] &&
          timetable[day][time][className]
        ) {
          timetable[day][time][className] = null;
          copiedLesson = null;
          copiedFrom = null;
          renderTimetable();
          recalcStats();
        }
      }
    }

    // --- A√ß√µes ---

    function addTeacher() {
      const nameInput = document.getElementById('teacherNameInput');
      const subjectSelect = document.getElementById('subjectSelect');
      const restDaySelect = document.getElementById('restDaySelect');
      const classSelect = document.getElementById('classSelect');

      const name = nameInput.value.trim();
      const subject = subjectSelect.value;
      const restDay = restDaySelect.value;

      // compat√≠vel com qualquer navegador
      const selectedClasses = Array.from(classSelect.options)
        .filter(o => o.selected)
        .map(o => o.value);

      if (!name || !subject) {
        alert('Preencha o nome do professor e selecione a disciplina.');
        return;
      }

      if (selectedClasses.length === 0) {
        alert('Selecione pelo menos uma turma em que o professor ir√° lecionar.');
        return;
      }

      const load = fixedLoads[subject];
      if (load === undefined) {
        alert('Disciplina selecionada inv√°lida.');
        return;
      }

      if (teachers.some(t => t.name.toUpperCase() === name.toUpperCase())) {
        alert('J√° existe um professor com este nome. Por favor, use um nome √∫nico (ex: Maria S. ou Maria C.).');
        return;
      }

      teachers.push({
        name: name,
        subject: subject,
        subjectUpper: subject.toUpperCase(),
        restDay: restDay,
        load: load,
        classes: selectedClasses,
        assigned: 0
      });

      nameInput.value = '';
      subjectSelect.value = '';
      restDaySelect.value = 'Nenhum';
      classSelect.selectedIndex = -1;

      renderTeacherList();
      recalcStats();
    }

    function removeTeacher(index) {
      teachers.splice(index, 1);
      renderTeacherList();
      recalcStats();
    }

    function clearTimetable() {
      initializeTimetable();
      renderTimetable();
      recalcStats();
    }

    // --- Distribui√ß√£o autom√°tica ---

    function distributeTimetable() {
      clearTimetable();

      if (teachers.length === 0) {
        alert("Adicione pelo menos um professor para distribuir.");
        return;
      }

      let allLessons = [];
      teachers.forEach(t => {
        if (!t.classes || t.classes.length === 0) return;
        t.classes.forEach(className => {
          for (let i = 0; i < t.load; i++) {
            allLessons.push({
              teacher: t.name,
              teacherUpper: t.name.toUpperCase(),
              subject: t.subject,
              subjectUpper: t.subject.toUpperCase(),
              className: className,
              restDay: t.restDay,
              maxPerDay: 2,
              load: t.load
            });
          }
        });
      });

      if (allLessons.length === 0) {
        alert('Nenhuma aula para distribuir. Verifique se os professores possuem turmas atribu√≠das.');
        return;
      }

      allLessons.sort((a, b) => {
        const aRestricted = a.restDay !== 'Nenhum' ? 1 : 0;
        const bRestricted = b.restDay !== 'Nenhum' ? 1 : 0;
        if (aRestricted !== bRestricted) return bRestricted - aRestricted;
        return b.load - a.load;
      });

      let unassignedLessons = [];

      for (const lesson of allLessons) {
        let slotFound = false;

        let availableSlots = [];
        days.forEach(day => {
          if (day === lesson.restDay) return;
          timeSlots.forEach(time => {
            availableSlots.push({ day, time });
          });
        });

        shuffleArray(availableSlots);

        for (const slot of availableSlots) {
          const { day, time } = slot;
          const className = lesson.className;

          if (teacherBusy(lesson.teacherUpper, day, time)) {
            continue;
          }

          if (countSubjectInDay(lesson.subjectUpper, className, day) >= lesson.maxPerDay) {
            continue;
          }

          if (timetable[day][time][className] !== null) {
            continue;
          }

          timetable[day][time][className] = {
            teacherName: lesson.teacher,
            teacherUpper: lesson.teacherUpper,
            subjectName: lesson.subject,
            subjectUpper: lesson.subjectUpper
          };

          slotFound = true;
          break;
        }

        if (!slotFound) {
          unassignedLessons.push(lesson);
        }
      }

      renderTimetable();
      recalcStats();

      if (unassignedLessons.length === 0) {
        alert("‚úÖ Distribui√ß√£o de hor√°rios conclu√≠da com sucesso! Todas as aulas foram alocadas.");
      } else {
        const unassignedCount = unassignedLessons.length;
        alert(`‚ö†Ô∏è Distribui√ß√£o conclu√≠da, mas ${unassignedCount} aulas n√£o puderam ser alocadas. Ajuste manualmente pelo quadro (drag and drop / copiar e colar).`);
      }
    }

    // --- Event Listeners ---

    document.getElementById('addTeacherButton').addEventListener('click', addTeacher);
    document.getElementById('distributeButton').addEventListener('click', distributeTimetable);
    document.getElementById('clearButton').addEventListener('click', clearTimetable);
    document.getElementById('exportPDF').addEventListener('click', exportPDF);
    document.getElementById('exportXLS').addEventListener('click', exportXLS);
    document.addEventListener('keydown', handleKeyDown);

    // Inicializa√ß√£o
    initializeTimetable();
    renderTimetable();
    recalcStats();
</script>

</body>

</html>